rules:
  - id: pyspark-udf-definition
    languages: [python]
    message: "$FUNC"
    severity: INFO
    # metadata:
    #   references:
    #     - https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.functions.udf.html
    pattern-either:
      - pattern: |
          @udf(...)
          def $FUNC(...):
              ...
      - pattern: |
          @udf
          def $FUNC(...):
              ...
      - pattern: |
          $FUNC = udf(...)

  - id: library-usage
    languages: [python]
    message: "$FUNC:$LIB:$CALL"
    severity: INFO
    pattern-either:
      - pattern: |
          import $LIB
          ...
          def $FUNC(...):
            ...
            $LIB.$CALL(...)
            ...
      - pattern: |
          from $LIB import $CALL
          ...
          def $FUNC(...):
            ...
            $CALL(...)
            ...

  - id: pyspark-df-expression
    languages: [python]
    message: "Detected PySpark DF operation."
    severity: INFO
    # metadata:
    #   references:
    #     - https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrame.html
    pattern-either:
      - patterns:
        - pattern: $DF.$OP(...)
        - metavariable-regex:
            metavariable: $DF
            regex: .*df.*
        - metavariable-pattern:
            metavariable: $OP
            pattern-either:
            - pattern: agg
            - pattern: count
            - pattern: crossJoin
            - pattern: distinct
            - pattern: exceptAll
            - pattern: exists
            - pattern: filter
            - pattern: groupBy
            - pattern: groupby
            - pattern: intersect
            - pattern: intersectAll
            - pattern: join
            - pattern: limit
            - pattern: orderBy
            - pattern: select
            - pattern: subtract